<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MIDI Generator Pro</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 30px;
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 10px;
            font-size: 2.5em;
        }
        
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }
        
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        @media (max-width: 768px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .control-panel {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
        }
        
        .control-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
            font-size: 14px;
        }
        
        select, input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        select:focus, input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        button {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .btn-add {
            background: #4CAF50;
            color: white;
        }
        
        .btn-add:hover {
            background: #45a049;
            transform: translateY(-2px);
        }
        
        .btn-clear {
            background: #ff6b6b;
            color: white;
        }
        
        .btn-clear:hover {
            background: #ee5a52;
            transform: translateY(-2px);
        }
        
        .btn-generate {
            background: #667eea;
            color: white;
            width: 100%;
            margin-top: 20px;
            font-size: 18px;
        }
        
        .btn-generate:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }
        
        .btn-generate:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .notes-section {
            margin: 20px 0;
        }
        
        .notes-section h2 {
            color: #333;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .notes-list {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            min-height: 150px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .note-item {
            background: white;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            animation: slideIn 0.3s ease;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .note-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .note-item.playing {
            background: #667eea;
            color: white;
            transform: scale(1.02);
        }
        
        .note-item.playing .note-number {
            background: white;
            color: #667eea;
        }
        
        .note-item.chord {
            border-left: 4px solid #ffc107;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .note-info {
            flex: 1;
        }
        
        .note-number {
            background: #667eea;
            color: white;
            padding: 5px 10px;
            border-radius: 50%;
            margin-right: 10px;
            font-weight: bold;
            display: inline-block;
            min-width: 30px;
            text-align: center;
        }
        
        .btn-delete {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 5px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .btn-delete:hover {
            background: #ee5a52;
        }
        
        .empty-state {
            text-align: center;
            color: #999;
            padding: 40px;
        }
        
        .settings-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        /* Player styles */
        .player-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            border-radius: 10px;
            color: white;
            transition: box-shadow 0.3s;
        }
        
        .player-section.playing {
            box-shadow: 0 0 30px rgba(76, 175, 80, 0.5);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 20px rgba(76, 175, 80, 0.3); }
            50% { box-shadow: 0 0 40px rgba(76, 175, 80, 0.6); }
        }
        
        .player-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .player-btn {
            background: white;
            color: #667eea;
            padding: 10px 20px;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .player-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .player-btn:disabled {
            background: #ccc;
            color: #666;
            cursor: not-allowed;
            transform: none;
        }

        .player-btn.loop-active {
            background: #4CAF50 !important;
            color: white !important;
        }
        
        .visualizer {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 20px;
            margin-top: 15px;
            text-align: center;
            min-height: 100px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 48px;
        }
        
        .piano-roll {
            display: flex;
            gap: 2px;
            justify-content: center;
            margin-top: 10px;
            height: 60px;
            align-items: flex-end;
        }
        
        .piano-bar {
            width: 20px;
            background: rgba(255,255,255,0.3);
            border-radius: 3px;
            transition: all 0.2s;
        }
        
        .piano-bar.active {
            background: white;
            transform: scaleY(1.2);
        }
        
        .tempo-control {
            margin-top: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .tempo-control input[type="range"] {
            flex: 1;
            height: 8px;
            border-radius: 5px;
            background: rgba(255,255,255,0.3);
            outline: none;
        }
        
        .tempo-control input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
        }
        
        .tempo-value {
            background: rgba(255,255,255,0.2);
            padding: 5px 15px;
            border-radius: 20px;
            min-width: 80px;
            text-align: center;
        }
        
        .instrument-selector {
            margin-top: 15px;
        }
        
        .instrument-selector select {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid rgba(255,255,255,0.3);
        }
        
        .instrument-selector select option {
            color: #333;
        }
        
        /* Quick presets */
        .presets-section {
            background: #fff3cd;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            transition: background 0.3s;
        }
        
        .presets-section h3 {
            color: #856404;
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        .preset-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .preset-btn {
            background: #fff;
            color: #856404;
            border: 2px solid #ffc107;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .preset-btn:hover {
            background: #ffc107;
            color: white;
        }
        
        /* Keyboard shortcuts */
        .shortcuts {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            font-size: 13px;
        }
        
        .shortcuts h4 {
            color: #004085;
            margin-bottom: 10px;
        }
        
        .shortcuts kbd {
            background: #004085;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: monospace;
        }
        
        /* Progress bar */
        .progress-bar {
            width: 100%;
            height: 4px;
            background: rgba(255,255,255,0.2);
            border-radius: 2px;
            margin-top: 10px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: white;
            width: 0%;
            transition: width 0.1s linear;
        }
        
        /* Statistics */
        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 15px;
        }
        
        .stat-card {
            background: rgba(255,255,255,0.1);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 12px;
            opacity: 0.8;
        }
        
        /* Note actions */
        .note-actions {
            display: flex;
            gap: 5px;
        }
        
        .btn-preview {
            background: #667eea;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .btn-preview:hover {
            background: #5568d3;
        }
        
        .timeline {
            margin-top: 15px;
            font-size: 12px;
            opacity: 0.8;
        }
        
        /* Chord builder */
        .chord-builder {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
        }
        
        .chord-builder h4 {
            color: #1565c0;
            margin-bottom: 10px;
        }
        
        .chord-notes {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 10px;
            min-height: 40px;
            align-items: center;
        }
        
        .chord-note-tag {
            background: #1976d2;
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .chord-note-tag button {
            background: rgba(255,255,255,0.3);
            border: none;
            color: white;
            cursor: pointer;
            padding: 0 5px;
            width: auto;
            font-size: 16px;
            line-height: 1;
            border-radius: 50%;
        }
        
        .chord-note-tag button:hover {
            background: rgba(255,255,255,0.5);
        }
        
        .btn-add-to-chord {
            background: #1976d2;
            color: white;
            padding: 8px 15px;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .btn-add-to-chord:hover {
            background: #1565c0;
        }
        
        .btn-clear-chord {
            background: #ff9800;
            color: white;
            padding: 8px 15px;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .btn-clear-chord:hover {
            background: #f57c00;
        }
        
        .note-details {
            font-size: 11px;
            color: #666;
            margin-top: 5px;
        }
        
        .chord-indicator {
            background: #ffc107;
            color: #333;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            margin-left: 5px;
            font-weight: bold;
        }

        /* Notification toast */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #4CAF50;
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 9999;
            animation: slideInRight 0.3s ease;
            display: none;
        }

        .toast.error {
            background: #f44336;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <div id="toast" class="toast"></div>
    
    <div class="container">
        <h1>üéµ MIDI Generator Pro</h1>
        <p class="subtitle">–°–æ–∑–¥–∞–≤–∞–π—Ç–µ –º–Ω–æ–≥–æ–≥–æ–ª–æ—Å–Ω—É—é –º—É–∑—ã–∫—É –ø—Ä—è–º–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ | –§–∏–Ω–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è v2.1</p>
        
        <!-- Quick Presets -->
        <div class="presets-section" id="presetsSection">
            <h3>‚ö° –ë—ã—Å—Ç—Ä—ã–µ –ø—Ä–µ—Å–µ—Ç—ã</h3>
            <div class="preset-buttons">
                <button class="preset-btn" onclick="loadPreset('scale')">üéº –ì–∞–º–º–∞ C Major</button>
                <button class="preset-btn" onclick="loadPreset('chords')">üéπ –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∞–∫–∫–æ—Ä–¥–æ–≤</button>
                <button class="preset-btn" onclick="loadPreset('melody')">üéµ –ü—Ä–æ—Å—Ç–∞—è –º–µ–ª–æ–¥–∏—è</button>
                <button class="preset-btn" onclick="loadPreset('piano')">üéπ –ú–µ–ª–æ–¥–∏—è + –ê–∫–∫–æ—Ä–¥—ã</button>
            </div>
        </div>
        
        <div class="main-grid">
            <!-- Left Column -->
            <div>
                <div class="control-panel">
                    <h3 style="margin-bottom: 15px; color: #333;">‚úèÔ∏è –î–æ–±–∞–≤–∏—Ç—å –Ω–æ—Ç—É/–∞–∫–∫–æ—Ä–¥</h3>
                    
                    <div class="settings-row">
                        <div class="control-group">
                            <label>üéº –ù–æ—Ç–∞:</label>
                            <select id="noteSelect">
                                <option value="48">C3 (–î–æ)</option>
                                <option value="50">D3 (–†–µ)</option>
                                <option value="52">E3 (–ú–∏)</option>
                                <option value="53">F3 (–§–∞)</option>
                                <option value="55">G3 (–°–æ–ª—å)</option>
                                <option value="57">A3 (–õ—è)</option>
                                <option value="59">B3 (–°–∏)</option>
                                <option value="60">C4 (–î–æ)</option>
                                <option value="61">C#4 (–î–æ#)</option>
                                <option value="62">D4 (–†–µ)</option>
                                <option value="63">D#4 (–†–µ#)</option>
                                <option value="64">E4 (–ú–∏)</option>
                                <option value="65">F4 (–§–∞)</option>
                                <option value="66">F#4 (–§–∞#)</option>
                                <option value="67">G4 (–°–æ–ª—å)</option>
                                <option value="68">G#4 (–°–æ–ª—å#)</option>
                                <option value="69">A4 (–õ—è)</option>
                                <option value="70">A#4 (–õ—è#)</option>
                                <option value="71">B4 (–°–∏)</option>
                                <option value="72">C5 (–î–æ)</option>
                                <option value="74">D5 (–†–µ)</option>
                                <option value="76">E5 (–ú–∏)</option>
                                <option value="77">F5 (–§–∞)</option>
                                <option value="79">G5 (–°–æ–ª—å)</option>
                                <option value="81">A5 (–õ—è)</option>
                                <option value="83">B5 (–°–∏)</option>
                            </select>
                        </div>
                        
                        <div class="control-group">
                            <label>‚è±Ô∏è –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:</label>
                            <select id="duration">
                                <option value="384">üéµ –¶–µ–ª–∞—è (1)</option>
                                <option value="288">ùÖóùÖ•. –ü–æ–ª–æ–≤–∏–Ω–Ω–∞—è —Å —Ç–æ—á–∫–æ–π</option>
                                <option value="192">ùÖóùÖ• –ü–æ–ª–æ–≤–∏–Ω–Ω–∞—è (1/2)</option>
                                <option value="144">‚ô©. –ß–µ—Ç–≤–µ—Ä—Ç–Ω–∞—è —Å —Ç–æ—á–∫–æ–π</option>
                                <option value="96" selected>‚ô© –ß–µ—Ç–≤–µ—Ä—Ç–Ω–∞—è (1/4)</option>
                                <option value="72">‚ô™. –í–æ—Å—å–º–∞—è —Å —Ç–æ—á–∫–æ–π</option>
                                <option value="48">‚ô™ –í–æ—Å—å–º–∞—è (1/8)</option>
                                <option value="24">‚ô¨ –®–µ—Å—Ç–Ω–∞–¥—Ü–∞—Ç–∞—è</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="control-group">
                        <label>üîä –ì—Ä–æ–º–∫–æ—Å—Ç—å: <span id="velocityDisplay">100</span></label>
                        <input type="range" id="velocity" value="100" min="0" max="127" 
                               oninput="document.getElementById('velocityDisplay').textContent = this.value">
                    </div>
                    
                    <div class="button-group">
                        <button class="btn-add" onclick="addNote()">‚ûï –î–æ–±–∞–≤–∏—Ç—å –Ω–æ—Ç—É</button>
                        <button class="btn-clear" onclick="clearNotes()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ</button>
                    </div>
                </div>
                
                <!-- Chord Builder -->
                <div class="chord-builder">
                    <h4>üéπ –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –∞–∫–∫–æ—Ä–¥–æ–≤ (–æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–µ –∑–≤—É—á–∞–Ω–∏–µ)</h4>
                    <p style="font-size: 12px; margin-bottom: 10px; color: #1565c0;">–î–æ–±–∞–≤—å—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ –Ω–æ—Ç, –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥—É—Ç –∑–≤—É—á–∞—Ç—å –≤–º–µ—Å—Ç–µ</p>
                    <div class="chord-notes" id="chordNotes">
                        <span style="color: #999; font-size: 12px;">–ù–µ—Ç –Ω–æ—Ç –≤ –∞–∫–∫–æ—Ä–¥–µ</span>
                    </div>
                    <div class="button-group">
                        <button class="btn-add-to-chord" onclick="addToChord()">‚ûï –í –∞–∫–∫–æ—Ä–¥</button>
                        <button class="btn-clear-chord" onclick="clearChord()">üîÑ –û—á–∏—Å—Ç–∏—Ç—å</button>
                        <button class="btn-add" onclick="addChord()">‚úÖ –î–æ–±–∞–≤–∏—Ç—å –∞–∫–∫–æ—Ä–¥</button>
                    </div>
                </div>
                
                <!-- Keyboard Shortcuts -->
                <div class="shortcuts">
                    <h4>‚å®Ô∏è –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏</h4>
                    <p>
                        <kbd>Enter</kbd> - –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ—Ç—É/–∞–∫–∫–æ—Ä–¥ | 
                        <kbd>Space</kbd> - –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏/–æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å<br>
                        <kbd>Ctrl+Del</kbd> - –æ—á–∏—Å—Ç–∏—Ç—å | 
                        <kbd>Ctrl+R</kbd> - —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å | 
                        <kbd>Ctrl+L</kbd> - –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –ø–æ–≤—Ç–æ—Ä
                    </p>
                </div>
            </div>
            
            <!-- Right Column -->
            <div>
                <!-- Player Section -->
                <div class="player-section" id="playerSection">
                    <h3 style="text-align: center; margin-bottom: 15px;">üéπ –ü—Ä–æ–∏–≥—Ä—ã–≤–∞—Ç–µ–ª—å</h3>
                    
                    <div class="stats">
                        <div class="stat-card">
                            <div class="stat-value" id="totalNotes">0</div>
                            <div class="stat-label">–≠–ª–µ–º–µ–Ω—Ç–æ–≤</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="totalDuration">0s</div>
                            <div class="stat-label">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="currentTempo">120</div>
                            <div class="stat-label">BPM</div>
                        </div>
                    </div>
                    
                    <div class="tempo-control">
                        <span>üéöÔ∏è –¢–µ–º–ø:</span>
                        <input type="range" id="tempoSlider" min="40" max="240" value="120" 
                               oninput="updateTempo(this.value)">
                        <span class="tempo-value" id="tempoValue">120 BPM</span>
                    </div>
                    
                    <div class="instrument-selector">
                        <label>üé∏ –¢–µ–º–±—Ä:</label>
                        <select id="waveform" onchange="updateWaveform(this.value)">
                            <option value="sine">üéπ –°–∏–Ω—É—Å–æ–∏–¥–∞ (–º—è–≥–∫–æ)</option>
                            <option value="square">üé∏ –ü—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫ (—Ä–µ—Ç—Ä–æ)</option>
                            <option value="sawtooth">üé∫ –ü–∏–ª–∞ (—è—Ä–∫–∏–π)</option>
                            <option value="triangle">üéª –¢—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫ (—Ç–µ–ø–ª—ã–π)</option>
                        </select>
                    </div>
                    
                    <div class="visualizer" id="visualizer">
                        <span>üéµ</span>
                        <div class="timeline" id="timeline"></div>
                    </div>
                    
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    
                    <div class="piano-roll" id="pianoRoll"></div>
                    
                    <div class="player-controls">
                        <button class="player-btn" id="playBtn" onclick="playMelody()" disabled>
                            <span>‚ñ∂Ô∏è</span> –ò–≥—Ä–∞—Ç—å
                        </button>
                        <button class="player-btn" id="stopBtn" onclick="stopMelody()" disabled>
                            <span>‚èπÔ∏è</span> –°—Ç–æ–ø
                        </button>
                        <button class="player-btn" id="loopBtn" onclick="toggleLoop()">
                            <span id="loopIcon">üîÅ</span> –ü–æ–≤—Ç–æ—Ä
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="notes-section">
            <h2>
                <span>üìù –°–ø–∏—Å–æ–∫ –Ω–æ—Ç –∏ –∞–∫–∫–æ—Ä–¥–æ–≤ (<span id="noteCount">0</span>)</span>
                <button class="player-btn" style="font-size: 12px; padding: 5px 15px;" onclick="reverseNotes()">
                    üîÑ –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å
                </button>
            </h2>
            <div class="notes-list" id="notesList">
                <div class="empty-state">
                    <p>–ù–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö –Ω–æ—Ç</p>
                    <p style="font-size: 14px; margin-top: 10px;">–î–æ–±–∞–≤—å—Ç–µ –Ω–æ—Ç—ã –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ—Å–µ—Ç</p>
                </div>
            </div>
        </div>
        
        <button class="btn-generate" id="generateBtn" onclick="generateMIDI()" disabled>
            üíæ –°–∫–∞—á–∞—Ç—å MIDI —Ñ–∞–π–ª
        </button>
    </div>
    
    <script>
        let notes = [];
        let currentChord = [];
        let audioContext = null;
        let isPlaying = false;
        let shouldStop = false;
        let currentTimeouts = [];
        let tempo = 120;
        let waveformType = 'sine';
        let loopEnabled = false;
        
        // ==================== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ====================
        
        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast' + (isError ? ' error' : '');
            toast.style.display = 'block';
            
            setTimeout(() => {
                toast.style.display = 'none';
            }, 3000);
        }
        
        function initAudio() {
            if (!audioContext) {
                try {
                    const AudioContextClass = window.AudioContext || window.webkitAudioContext;
                    if (!AudioContextClass) {
                        throw new Error('Web Audio API –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');
                    }
                    audioContext = new AudioContextClass();
                    
                    if (audioContext.state === 'suspended') {
                        const resumeAudio = () => {
                            audioContext.resume();
                            document.removeEventListener('click', resumeAudio);
                            document.removeEventListener('keydown', resumeAudio);
                        };
                        document.addEventListener('click', resumeAudio, { once: true });
                        document.addEventListener('keydown', resumeAudio, { once: true });
                    }
                } catch (error) {
                    showToast('‚ö†Ô∏è Web Audio API –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è', true);
                    console.error('Audio init error:', error);
                    return false;
                }
            }
            return true;
        }
        
        function updateTempo(value) {
            tempo = parseInt(value);
            document.getElementById('tempoValue').textContent = tempo + ' BPM';
            document.getElementById('currentTempo').textContent = tempo;
            updateStats();
            saveToLocalStorage();
        }
        
        function updateWaveform(value) {
            waveformType = value;
            saveToLocalStorage();
        }
        
        function toggleLoop() {
            loopEnabled = !loopEnabled;
            const icon = document.getElementById('loopIcon');
            const btn = document.getElementById('loopBtn');
            
            icon.textContent = loopEnabled ? 'üîÇ' : 'üîÅ';
            
            if (loopEnabled) {
                btn.classList.add('loop-active');
                showToast('üîÇ –ü–æ–≤—Ç–æ—Ä –≤–∫–ª—é—á–µ–Ω ‚Äî –º–µ–ª–æ–¥–∏—è –±—É–¥–µ—Ç –∏–≥—Ä–∞—Ç—å –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ');
            } else {
                btn.classList.remove('loop-active');
                showToast('üîÅ –ü–æ–≤—Ç–æ—Ä –≤—ã–∫–ª—é—á–µ–Ω ‚Äî –º–µ–ª–æ–¥–∏—è —Å—ã–≥—Ä–∞–µ—Ç –æ–¥–∏–Ω —Ä–∞–∑');
            }
            
            saveToLocalStorage();
        }
        
        function midiToFrequency(midi) {
            return 440 * Math.pow(2, (midi - 69) / 12);
        }
        
        // ==================== –ê–£–î–ò–û –í–û–°–ü–†–û–ò–ó–í–ï–î–ï–ù–ò–ï ====================
        
        function playNote(frequency, duration, velocity) {
            if (!initAudio()) return null;
            
            try {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.type = waveformType;
                oscillator.frequency.value = frequency;
                
                const volume = velocity / 127;
                gainNode.gain.value = volume * 0.3;
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + duration);
                
                return oscillator;
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è:', error);
                return null;
            }
        }
        
        function playChord(noteArray, duration) {
            const oscillators = [];
            noteArray.forEach(noteData => {
                const frequency = midiToFrequency(noteData.note);
                const osc = playNote(frequency, duration, noteData.velocity);
                if (osc) oscillators.push(osc);
            });
            return oscillators;
        }
        
        async function playMelody() {
            if (notes.length === 0) {
                showToast('–î–æ–±–∞–≤—å—Ç–µ –Ω–æ—Ç—ã –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è', true);
                return;
            }
            
            if (isPlaying) {
                console.warn('‚ö†Ô∏è –£–∂–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è');
                return;
            }
            
            isPlaying = true;
            shouldStop = false;
            
            if (!initAudio()) {
                isPlaying = false;
                showToast('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∞—É–¥–∏–æ', true);
                return;
            }
            
            const visualizer = document.getElementById('visualizer');
            const timeline = document.getElementById('timeline');
            const progressFill = document.getElementById('progressFill');
            const playBtn = document.getElementById('playBtn');
            const stopBtn = document.getElementById('stopBtn');
            const playerSection = document.getElementById('playerSection');
            
            playBtn.disabled = true;
            stopBtn.disabled = false;
            playerSection.classList.add('playing');
            
            const quarterNoteDuration = 60 / tempo;
            const ticksPerQuarter = 96;
            
            updatePianoRoll();
            
            let loopCount = 0;
            const maxLoops = 1000;
            
            try {
                do {
                    if (shouldStop) break;
                    
                    loopCount++;
                    
                    if (loopCount > maxLoops) {
                        console.warn('–î–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç –ø–æ–≤—Ç–æ—Ä–æ–≤');
                        showToast('‚ö†Ô∏è –î–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç –ø–æ–≤—Ç–æ—Ä–æ–≤ (1000)', true);
                        break;
                    }
                    
                    currentTimeouts.forEach(timeout => clearTimeout(timeout));
                    currentTimeouts = [];
                    
                    for (let i = 0; i < notes.length; i++) {
                        if (shouldStop) break;
                        
                        const item = notes[i];
                        const duration = (item.duration / ticksPerQuarter) * quarterNoteDuration;
                        
                        const progress = ((i + 1) / notes.length) * 100;
                        progressFill.style.width = progress + '%';
                        
                        const noteItems = document.querySelectorAll('.note-item');
                        noteItems.forEach((elem, index) => {
                            elem.classList.toggle('playing', index === i);
                        });
                        
                        if (item.isChord) {
                            playChord(item.notes, duration);
                            const noteNames = item.notes.map(n => n.noteText.split(' ')[0]).join(' + ');
                            visualizer.innerHTML = `<span style="font-size: 48px;">üéπ</span><br><span style="font-size: 18px;">${noteNames}</span>`;
                        } else {
                            const frequency = midiToFrequency(item.note);
                            playNote(frequency, duration, item.velocity);
                            visualizer.innerHTML = `<span style="font-size: 48px;">üéµ</span><br><span style="font-size: 24px;">${item.noteText}</span>`;
                        }
                        
                        const loopText = loopEnabled ? ` [–¶–∏–∫–ª ${loopCount}]` : '';
                        timeline.textContent = `–≠–ª–µ–º–µ–Ω—Ç ${i + 1} –∏–∑ ${notes.length}${loopText}`;
                        
                        const bars = document.querySelectorAll('.piano-bar');
                        bars.forEach((bar, idx) => {
                            bar.classList.toggle('active', idx === i % bars.length);
                        });
                        
                        await new Promise(resolve => {
                            const timeout = setTimeout(resolve, duration * 1000);
                            currentTimeouts.push(timeout);
                        });
                        
                        if (shouldStop) break;
                    }
                    
                    document.querySelectorAll('.note-item').forEach(item => {
                        item.classList.remove('playing');
                    });
                    
                    document.querySelectorAll('.piano-bar').forEach(bar => {
                        bar.classList.remove('active');
                    });
                    
                    if (loopEnabled && !shouldStop) {
                        progressFill.style.width = '0%';
                        visualizer.innerHTML = '<span style="font-size: 48px;">üîÑ</span><br><span style="font-size: 14px;">–ü–æ–≤—Ç–æ—Ä...</span>';
                        
                        await new Promise(resolve => {
                            const timeout = setTimeout(resolve, 500);
                            currentTimeouts.push(timeout);
                        });
                    }
                    
                } while (loopEnabled && !shouldStop);
                
                if (!shouldStop) {
                    showToast(`‚úÖ –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ (${loopEnabled ? loopCount + ' —Ü–∏–∫–ª–æ–≤' : '1 —Ä–∞–∑'})`);
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è:', error);
                showToast('‚ùå –û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è', true);
            } finally {
                isPlaying = false;
                shouldStop = false;
                
                currentTimeouts.forEach(timeout => clearTimeout(timeout));
                currentTimeouts = [];
                
                visualizer.innerHTML = '<span>üéµ</span>';
                timeline.textContent = '';
                progressFill.style.width = '0%';
                
                playBtn.disabled = false;
                stopBtn.disabled = true;
                playerSection.classList.remove('playing');
                
                document.querySelectorAll('.note-item').forEach(item => {
                    item.classList.remove('playing');
                });
                
                document.querySelectorAll('.piano-bar').forEach(bar => {
                    bar.classList.remove('active');
                });
            }
        }
        
        function stopMelody() {
            if (!isPlaying) {
                console.warn('‚ö†Ô∏è –ù–∏—á–µ–≥–æ –Ω–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è');
                return;
            }
            
            console.log('üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è...');
            
            shouldStop = true;
            
            currentTimeouts.forEach(timeout => clearTimeout(timeout));
            currentTimeouts = [];
            
            try {
                if (audioContext && audioContext.state === 'running') {
                    const silence = audioContext.createGain();
                    silence.gain.value = 0;
                    silence.connect(audioContext.destination);
                }
            } catch (e) {
                console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∞—É–¥–∏–æ:', e);
            }
            
            setTimeout(() => {
                if (isPlaying) {
                    console.warn('‚ö†Ô∏è –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π —Å–±—Ä–æ—Å isPlaying');
                    isPlaying = false;
                }
            }, 100);
            
            showToast('‚èπÔ∏è –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
        }
        
        // ==================== –£–ü–†–ê–í–õ–ï–ù–ò–ï –ù–û–¢–ê–ú–ò ====================
        
        function updatePianoRoll() {
            const pianoRoll = document.getElementById('pianoRoll');
            pianoRoll.innerHTML = '';
            
            const maxBars = Math.min(notes.length, 20);
            for (let i = 0; i < maxBars; i++) {
                const bar = document.createElement('div');
                bar.className = 'piano-bar';
                let avgVelocity;
                if (notes[i].isChord) {
                    avgVelocity = notes[i].notes.reduce((sum, n) => sum + n.velocity, 0) / notes[i].notes.length;
                } else {
                    avgVelocity = notes[i].velocity;
                }
                const height = (avgVelocity / 127) * 60;
                bar.style.height = height + 'px';
                pianoRoll.appendChild(bar);
            }
        }
        
        function addToChord() {
            const noteValue = parseInt(document.getElementById('noteSelect').value);
            const noteText = document.getElementById('noteSelect').options[document.getElementById('noteSelect').selectedIndex].text;
            const velocity = parseInt(document.getElementById('velocity').value);
            
            if (currentChord.some(n => n.note === noteValue)) {
                showToast('–≠—Ç–∞ –Ω–æ—Ç–∞ —É–∂–µ –≤ –∞–∫–∫–æ—Ä–¥–µ!', true);
                return;
            }
            
            currentChord.push({
                note: noteValue,
                noteText: noteText,
                velocity: velocity
            });
            
            updateChordDisplay();
            
            const frequency = midiToFrequency(noteValue);
            playNote(frequency, 0.3, velocity);
        }
        
        function removeFromChord(index) {
            currentChord.splice(index, 1);
            updateChordDisplay();
        }
        
        function clearChord() {
            currentChord = [];
            updateChordDisplay();
        }
        
        function updateChordDisplay() {
            const container = document.getElementById('chordNotes');
            if (currentChord.length === 0) {
                container.innerHTML = '<span style="color: #999; font-size: 12px;">–ù–µ—Ç –Ω–æ—Ç –≤ –∞–∫–∫–æ—Ä–¥–µ</span>';
            } else {
                container.innerHTML = currentChord.map((note, index) => `
                    <div class="chord-note-tag">
                        ${note.noteText.split(' ')[0]}
                        <button onclick="removeFromChord(${index})" title="–£–¥–∞–ª–∏—Ç—å">√ó</button>
                    </div>
                `).join('');
            }
        }
        
        function addChord() {
            if (currentChord.length === 0) {
                showToast('–î–æ–±–∞–≤—å—Ç–µ –Ω–æ—Ç—ã –≤ –∞–∫–∫–æ—Ä–¥!', true);
                return;
            }
            
            if (currentChord.length === 1) {
                showToast('–í –∞–∫–∫–æ—Ä–¥–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –º–∏–Ω–∏–º—É–º 2 –Ω–æ—Ç—ã', true);
                return;
            }
            
            const duration = parseInt(document.getElementById('duration').value);
            const durationText = document.getElementById('duration').options[document.getElementById('duration').selectedIndex].text;
            
            notes.push({
                isChord: true,
                notes: [...currentChord],
                duration: duration,
                durationText: durationText
            });
            
            const quarterNoteDuration = 60 / tempo;
            const ticksPerQuarter = 96;
            const durationSeconds = (duration / ticksPerQuarter) * quarterNoteDuration;
            playChord(currentChord, durationSeconds);
            
            showToast(`‚úÖ –ê–∫–∫–æ—Ä–¥ –∏–∑ ${currentChord.length} –Ω–æ—Ç –¥–æ–±–∞–≤–ª–µ–Ω`);
            
            clearChord();
            updateNotesList();
            updateStats();
            saveToLocalStorage();
        }
        
        function addNote() {
            const noteValue = parseInt(document.getElementById('noteSelect').value);
            const noteText = document.getElementById('noteSelect').options[document.getElementById('noteSelect').selectedIndex].text;
            const duration = parseInt(document.getElementById('duration').value);
            const durationText = document.getElementById('duration').options[document.getElementById('duration').selectedIndex].text;
            const velocity = parseInt(document.getElementById('velocity').value);
            
            notes.push({
                isChord: false,
                note: noteValue,
                noteText: noteText,
                duration: duration,
                durationText: durationText,
                velocity: velocity
            });
            
            const frequency = midiToFrequency(noteValue);
            const quarterNoteDuration = 60 / tempo;
            const previewDuration = Math.min(0.5, (duration / 96) * quarterNoteDuration);
            playNote(frequency, previewDuration, velocity);
            
            updateNotesList();
            updateStats();
            saveToLocalStorage();
        }
        
        function deleteNote(index) {
            notes.splice(index, 1);
            showToast('üóëÔ∏è –≠–ª–µ–º–µ–Ω—Ç —É–¥–∞–ª–µ–Ω');
            updateNotesList();
            updateStats();
            saveToLocalStorage();
        }
        
        function previewNote(index) {
            const item = notes[index];
            const quarterNoteDuration = 60 / tempo;
            const ticksPerQuarter = 96;
            const duration = (item.duration / ticksPerQuarter) * quarterNoteDuration;
            
            if (item.isChord) {
                playChord(item.notes, duration);
            } else {
                const frequency = midiToFrequency(item.note);
                playNote(frequency, duration, item.velocity);
            }
        }
        
        function clearNotes() {
            if (notes.length === 0) return;
            
            if (confirm(`–£–¥–∞–ª–∏—Ç—å –≤—Å–µ ${notes.length} —ç–ª–µ–º–µ–Ω—Ç–æ–≤?`)) {
                notes = [];
                showToast('üóëÔ∏è –í—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã —É–¥–∞–ª–µ–Ω—ã');
                updateNotesList();
                updateStats();
                saveToLocalStorage();
            }
        }
        
        function reverseNotes() {
            if (notes.length < 2) {
                showToast('–î–æ–±–∞–≤—å—Ç–µ –º–∏–Ω–∏–º—É–º 2 —ç–ª–µ–º–µ–Ω—Ç–∞', true);
                return;
            }
            
            notes.reverse();
            showToast('üîÑ –°–ø–∏—Å–æ–∫ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç');
            updateNotesList();
            saveToLocalStorage();
        }
        
        // ==================== UI –û–ë–ù–û–í–õ–ï–ù–ò–Ø ====================
        
        function updateStats() {
            const quarterNoteDuration = 60 / tempo;
            const ticksPerQuarter = 96;
            let totalSeconds = 0;
            
            notes.forEach(item => {
                totalSeconds += (item.duration / ticksPerQuarter) * quarterNoteDuration;
            });
            
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = Math.floor(totalSeconds % 60);
            
            document.getElementById('totalNotes').textContent = notes.length;
            document.getElementById('totalDuration').textContent = 
                minutes > 0 ? `${minutes}m ${seconds}s` : `${seconds}s`;
        }
        
        function updateNotesList() {
            const list = document.getElementById('notesList');
            const generateBtn = document.getElementById('generateBtn');
            const playBtn = document.getElementById('playBtn');
            const noteCount = document.getElementById('noteCount');
            
            noteCount.textContent = notes.length;
            
            if (notes.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <p>–ù–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö –Ω–æ—Ç</p>
                        <p style="font-size: 14px; margin-top: 10px;">–î–æ–±–∞–≤—å—Ç–µ –Ω–æ—Ç—ã –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ—Å–µ—Ç</p>
                    </div>
                `;
                generateBtn.disabled = true;
                playBtn.disabled = true;
                document.getElementById('pianoRoll').innerHTML = '';
            } else {
                list.innerHTML = notes.map((item, index) => {
                    let displayText;
                    let durationStr = item.durationText.replace(/[üéµùÖóùÖ•‚ô©‚ô™‚ô¨.]/g, '').trim();
                    
                    if (item.isChord) {
                        const noteNames = item.notes.map(n => n.noteText.split(' ')[0]).join(', ');
                        displayText = `<strong>üéπ ${noteNames}</strong>`;
                    } else {
                        displayText = `<strong>${item.noteText}</strong>`;
                    }
                    
                    return `
                        <div class="note-item ${item.isChord ? 'chord' : ''}" onclick="previewNote(${index})">
                            <div class="note-info">
                                <span class="note-number">${index + 1}</span>
                                ${displayText}
                                ${item.isChord ? '<span class="chord-indicator">' + item.notes.length + ' –ù–û–¢</span>' : ''}
                                <div class="note-details">
                                    ${durationStr} ${!item.isChord ? `| –ì—Ä–æ–º–∫–æ—Å—Ç—å: ${item.velocity}` : ''}
                                </div>
                            </div>
                            <div class="note-actions">
                                <button class="btn-preview" onclick="event.stopPropagation(); previewNote(${index})" title="–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä">‚ñ∂Ô∏è</button>
                                <button class="btn-delete" onclick="event.stopPropagation(); deleteNote(${index})" title="–£–¥–∞–ª–∏—Ç—å">‚úï</button>
                            </div>
                        </div>
                    `;
                }).join('');
                generateBtn.disabled = false;
                playBtn.disabled = false;
                updatePianoRoll();
            }
        }
        
        // ==================== –ü–†–ï–°–ï–¢–´ ====================
        
        function loadPreset(type) {
            if (notes.length > 0 && !confirm('–ó–∞–º–µ–Ω–∏—Ç—å —Ç–µ–∫—É—â–∏–µ –Ω–æ—Ç—ã –ø—Ä–µ—Å–µ—Ç–æ–º?')) {
                return;
            }
            
            const presets = {
                'scale': [
                    {isChord: false, note: 60, noteText: 'C4 (–î–æ)', duration: 96, durationText: '‚ô© –ß–µ—Ç–≤–µ—Ä—Ç–Ω–∞—è (1/4)', velocity: 100},
                    {isChord: false, note: 62, noteText: 'D4 (–†–µ)', duration: 96, durationText: '‚ô© –ß–µ—Ç–≤–µ—Ä—Ç–Ω–∞—è (1/4)', velocity: 100},
                    {isChord: false, note: 64, noteText: 'E4 (–ú–∏)', duration: 96, durationText: '‚ô© –ß–µ—Ç–≤–µ—Ä—Ç–Ω–∞—è (1/4)', velocity: 100},
                    {isChord: false, note: 65, noteText: 'F4 (–§–∞)', duration: 96, durationText: '‚ô© –ß–µ—Ç–≤–µ—Ä—Ç–Ω–∞—è (1/4)', velocity: 100},
                    {isChord: false, note: 67, noteText: 'G4 (–°–æ–ª—å)', duration: 96, durationText: '‚ô© –ß–µ—Ç–≤–µ—Ä—Ç–Ω–∞—è (1/4)', velocity: 100},
                    {isChord: false, note: 69, noteText: 'A4 (–õ—è)', duration: 96, durationText: '‚ô© –ß–µ—Ç–≤–µ—Ä—Ç–Ω–∞—è (1/4)', velocity: 100},
                    {isChord: false, note: 71, noteText: 'B4 (–°–∏)', duration: 96, durationText: '‚ô© –ß–µ—Ç–≤–µ—Ä—Ç–Ω–∞—è (1/4)', velocity: 100},
                    {isChord: false, note: 72, noteText: 'C5 (–î–æ)', duration: 192, durationText: 'ùÖóùÖ• –ü–æ–ª–æ–≤–∏–Ω–Ω–∞—è (1/2)', velocity: 110}
                ],
                'chords': [
                    {
                        isChord: true,
                        notes: [
                            {note: 60, noteText: 'C4 (–î–æ)', velocity: 100},
                            {note: 64, noteText: 'E4 (–ú–∏)', velocity: 100},
                            {note: 67, noteText: 'G4 (–°–æ–ª—å)', velocity: 100}
                        ],
                        duration: 192,
                        durationText: 'ùÖóùÖ• –ü–æ–ª–æ–≤–∏–Ω–Ω–∞—è (1/2)'
                    },
                    {
                        isChord: true,
                        notes: [
                            {note: 65, noteText: 'F4 (–§–∞)', velocity: 100},
                            {note: 69, noteText: 'A4 (–õ—è)', velocity: 100},
                            {note: 72, noteText: 'C5 (–î–æ)', velocity: 100}
                        ],
                        duration: 192,
                        durationText: 'ùÖóùÖ• –ü–æ–ª–æ–≤–∏–Ω–Ω–∞—è (1/2)'
                    },
                    {
                        isChord: true,
                        notes: [
                            {note: 67, noteText: 'G4 (–°–æ–ª—å)', velocity: 100},
                            {note: 71, noteText: 'B4 (–°–∏)', velocity: 100},
                            {note: 74, noteText: 'D5 (–†–µ)', velocity: 100}
                        ],
                        duration: 192,
                        durationText: 'ùÖóùÖ• –ü–æ–ª–æ–≤–∏–Ω–Ω–∞—è (1/2)'
                    },
                    {
                        isChord: true,
                        notes: [
                            {note: 60, noteText: 'C4 (–î–æ)', velocity: 110},
                            {note: 64, noteText: 'E4 (–ú–∏)', velocity: 110},
                            {note: 67, noteText: 'G4 (–°–æ–ª—å)', velocity: 110}
                        ],
                        duration: 384,
                        durationText: 'üéµ –¶–µ–ª–∞—è (1)'
                    }
                ],
                'melody': [
                    {isChord: false, note: 60, noteText: 'C4 (–î–æ)', duration: 96, durationText: '‚ô© –ß–µ—Ç–≤–µ—Ä—Ç–Ω–∞—è (1/4)', velocity: 90},
                    {isChord: false, note: 64, noteText: 'E4 (–ú–∏)', duration: 96, durationText: '‚ô© –ß–µ—Ç–≤–µ—Ä—Ç–Ω–∞—è (1/4)', velocity: 95},
                    {isChord: false, note: 67, noteText: 'G4 (–°–æ–ª—å)', duration: 96, durationText: '‚ô© –ß–µ—Ç–≤–µ—Ä—Ç–Ω–∞—è (1/4)', velocity: 100},
                    {isChord: false, note: 72, noteText: 'C5 (–î–æ)', duration: 96, durationText: '‚ô© –ß–µ—Ç–≤–µ—Ä—Ç–Ω–∞—è (1/4)', velocity: 105},
                    {isChord: false, note: 67, noteText: 'G4 (–°–æ–ª—å)', duration: 96, durationText: '‚ô© –ß–µ—Ç–≤–µ—Ä—Ç–Ω–∞—è (1/4)', velocity: 100},
                    {isChord: false, note: 64, noteText: 'E4 (–ú–∏)', duration: 96, durationText: '‚ô© –ß–µ—Ç–≤–µ—Ä—Ç–Ω–∞—è (1/4)', velocity: 95},
                    {isChord: false, note: 60, noteText: 'C4 (–î–æ)', duration: 192, durationText: 'ùÖóùÖ• –ü–æ–ª–æ–≤–∏–Ω–Ω–∞—è (1/2)', velocity: 90}
                ],
                'piano': [
                    {isChord: false, note: 72, noteText: 'C5 (–î–æ)', duration: 96, durationText: '‚ô© –ß–µ—Ç–≤–µ—Ä—Ç–Ω–∞—è (1/4)', velocity: 100},
                    {
                        isChord: true,
                        notes: [
                            {note: 48, noteText: 'C3 (–î–æ)', velocity: 70},
                            {note: 52, noteText: 'E3 (–ú–∏)', velocity: 70},
                            {note: 55, noteText: 'G3 (–°–æ–ª—å)', velocity: 70}
                        ],
                        duration: 96,
                        durationText: '‚ô© –ß–µ—Ç–≤–µ—Ä—Ç–Ω–∞—è (1/4)'
                    },
                    {isChord: false, note: 76, noteText: 'E5 (–ú–∏)', duration: 96, durationText: '‚ô© –ß–µ—Ç–≤–µ—Ä—Ç–Ω–∞—è (1/4)', velocity: 105},
                    {
                        isChord: true,
                        notes: [
                            {note: 57, noteText: 'A3 (–õ—è)', velocity: 70},
                            {note: 60, noteText: 'C4 (–î–æ)', velocity: 70},
                            {note: 64, noteText: 'E4 (–ú–∏)', velocity: 70}
                        ],
                        duration: 96,
                        durationText: '‚ô© –ß–µ—Ç–≤–µ—Ä—Ç–Ω–∞—è (1/4)'
                    },
                    {
                        isChord: true,
                        notes: [
                            {note: 48, noteText: 'C3 (–î–æ)', velocity: 80},
                            {note: 60, noteText: 'C4 (–î–æ)', velocity: 90},
                            {note: 64, noteText: 'E4 (–ú–∏)', velocity: 90},
                            {note: 67, noteText: 'G4 (–°–æ–ª—å)', velocity: 90},
                            {note: 72, noteText: 'C5 (–î–æ)', velocity: 100}
                        ],
                        duration: 384,
                        durationText: 'üéµ –¶–µ–ª–∞—è (1)'
                    }
                ]
            };
            
            notes = presets[type] || [];
            showToast('‚ú® –ü—Ä–µ—Å–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω');
            
            const presetsSection = document.getElementById('presetsSection');
            presetsSection.style.background = '#d4edda';
            setTimeout(() => {
                presetsSection.style.background = '#fff3cd';
            }, 300);
            
            updateNotesList();
            updateStats();
            saveToLocalStorage();
        }
        
        // ==================== –ì–ï–ù–ï–†–ê–¶–ò–Ø MIDI ====================
        
        function toVariableLength(value) {
            if (value === 0) return [0x00];
            
            const bytes = [];
            bytes.push(value & 0x7F);
            
            value >>= 7;
            while (value > 0) {
                bytes.unshift((value & 0x7F) | 0x80);
                value >>= 7;
            }
            
            return bytes;
        }
        
        function generateMIDI() {
            if (notes.length === 0) {
                showToast('–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –Ω–æ—Ç—É!', true);
                return;
            }
            
            try {
                const header = [
                    0x4d, 0x54, 0x68, 0x64,
                    0x00, 0x00, 0x00, 0x06,
                    0x00, 0x00,
                    0x00, 0x01,
                    0x00, 0x60
                ];
                
                const events = [];
                
                const microsecondsPerQuarter = Math.floor(60000000 / tempo);
                const tempoBytes = [
                    (microsecondsPerQuarter >> 16) & 0xFF,
                    (microsecondsPerQuarter >> 8) & 0xFF,
                    microsecondsPerQuarter & 0xFF
                ];
                
                events.push(0x00, 0xFF, 0x51, 0x03, ...tempoBytes);
                
                notes.forEach((item) => {
                    if (item.isChord) {
                        item.notes.forEach(() => {
                            events.push(0x00, 0x90, item.notes[0].note, item.notes[0].velocity);
                        });
                        
                        item.notes.forEach((noteData, noteIndex) => {
                            events.push(0x00, 0x90, noteData.note, noteData.velocity);
                        });
                        
                        const deltaTime = toVariableLength(item.duration);
                        events.push(...deltaTime, 0x80, item.notes[0].note, 0x00);
                        
                        for (let i = 1; i < item.notes.length; i++) {
                            events.push(0x00, 0x80, item.notes[i].note, 0x00);
                        }
                    } else {
                        events.push(0x00, 0x90, item.note, item.velocity);
                        
                        const deltaTime = toVariableLength(item.duration);
                        events.push(...deltaTime, 0x80, item.note, 0x00);
                    }
                });
                
                events.push(0x00, 0xFF, 0x2F, 0x00);
                
                const trackLength = events.length;
                const track = [
                    0x4d, 0x54, 0x72, 0x6b,
                    (trackLength >> 24) & 0xFF,
                    (trackLength >> 16) & 0xFF,
                    (trackLength >> 8) & 0xFF,
                    trackLength & 0xFF
                ];
                
                const midiData = new Uint8Array([...header, ...track, ...events]);
                
                const blob = new Blob([midiData], { type: 'audio/midi' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `melody_${Date.now()}.mid`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showToast('‚úÖ MIDI —Ñ–∞–π–ª —É—Å–ø–µ—à–Ω–æ —Å–∫–∞—á–∞–Ω!');
                
            } catch (error) {
                showToast('‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: ' + error.message, true);
                console.error('–û—à–∏–±–∫–∞ MIDI:', error);
            }
        }
        
        // ==================== –ê–í–¢–û–°–û–•–†–ê–ù–ï–ù–ò–ï ====================
        
        function saveToLocalStorage() {
            try {
                localStorage.setItem('midi_notes', JSON.stringify(notes));
                localStorage.setItem('midi_tempo', tempo);
                localStorage.setItem('midi_waveform', waveformType);
                localStorage.setItem('midi_loop', loopEnabled);
            } catch (e) {
                console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å:', e);
            }
        }
        
        function loadFromLocalStorage() {
            try {
                const savedNotes = localStorage.getItem('midi_notes');
                const savedTempo = localStorage.getItem('midi_tempo');
                const savedWaveform = localStorage.getItem('midi_waveform');
                const savedLoop = localStorage.getItem('midi_loop');
                
                if (savedNotes) {
                    notes = JSON.parse(savedNotes);
                    updateNotesList();
                    if (notes.length > 0) {
                        showToast('üíæ –ü—Ä–æ–µ–∫—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏–∑ –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
                    }
                }
                
                if (savedTempo) {
                    tempo = parseInt(savedTempo);
                    document.getElementById('tempoSlider').value = tempo;
                    updateTempo(tempo);
                }
                
                if (savedWaveform) {
                    waveformType = savedWaveform;
                    document.getElementById('waveform').value = waveformType;
                }
                
                if (savedLoop) {
                    loopEnabled = savedLoop === 'true';
                    const btn = document.getElementById('loopBtn');
                    const icon = document.getElementById('loopIcon');
                    icon.textContent = loopEnabled ? 'üîÇ' : 'üîÅ';
                    if (loopEnabled) {
                        btn.classList.add('loop-active');
                    }
                }
            } catch (e) {
                console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å:', e);
            }
        }
        
        // ==================== –ì–û–†–Ø–ß–ò–ï –ö–õ–ê–í–ò–®–ò ====================
        
        document.addEventListener('keydown', function(e) {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') {
                if (e.key === 'Enter') {
                    if (currentChord.length > 0) {
                        addChord();
                    } else {
                        addNote();
                    }
                }
                return;
            }
            
            if (e.key === ' ') {
                e.preventDefault();
                if (isPlaying) {
                    stopMelody();
                } else if (notes.length > 0) {
                    playMelody();
                }
            }
            
            if ((e.ctrlKey || e.metaKey) && (e.key === 'Delete' || e.key === 'Backspace')) {
                e.preventDefault();
                clearNotes();
            }
            
            if ((e.ctrlKey || e.metaKey) && e.key === 'r') {
                e.preventDefault();
                reverseNotes();
            }
            
            if ((e.ctrlKey || e.metaKey) && e.key === 'l') {
                e.preventDefault();
                toggleLoop();
            }
        });
        
        // ==================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ====================
        
        window.addEventListener('DOMContentLoaded', () => {
            loadFromLocalStorage();
            updateStats();
            updateChordDisplay();
        });
        
        setInterval(() => {
            if (notes.length > 0) {
                saveToLocalStorage();
            }
        }, 30000);
    </script>
</body>
</html>
